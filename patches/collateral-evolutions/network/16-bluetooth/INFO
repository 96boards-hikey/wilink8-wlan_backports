These changes are required to backport blueooth. A lot can be optimized
here still, but for now we keep this here.

